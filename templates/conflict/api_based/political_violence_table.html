<!DOCTYPE html>
<html>
<head>
    <title>Political Violence Table</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 6px;
        }
        th {
            background: #f2f2f2;
        }
        .controls {
            margin-bottom: 10px;
        }
        .pagination {
            margin-top: 10px;
        }
    </style>
</head>

<body>

<h2>Political Violence Data (Stage 3)</h2>

<div class="controls">
    <label>Year:</label>
    <select id="yearFilter">
        <option value="">All</option>
        <option value="2020">2020</option>
        <option value="2021">2021</option>
        <option value="2022">2022</option>
    </select>

    <label>Month:</label>
    <select id="monthFilter">
        <option value="">All</option>
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>

    <button id="applyFilters">Apply</button>
</div>

<table id="data-table">
    <thead>
        <tr>
            <th>Province</th>
            <th>Year</th>
            <th>Month</th>
            <th>Events</th>
            <th>Fatalities</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="pagination">
    <button id="prevBtn">Previous</button>
    <span id="pageInfo"></span>
    <button id="nextBtn">Next</button>
</div>

<script>
    const BASE_API_URL = "/api/table/";

    const tableBody = document.querySelector("#data-table tbody");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const pageInfo = document.getElementById("pageInfo");

    const yearFilter = document.getElementById("yearFilter");
    const monthFilter = document.getElementById("monthFilter");
    const applyBtn = document.getElementById("applyFilters");

    let currentPage = 1;
    let nextPageUrl = null;
    let prevPageUrl = null;

    // Load initial data
    loadPage(buildUrl());

    function buildUrl(pageUrl = null) {
        if (pageUrl) return pageUrl;

        const params = new URLSearchParams();
        params.append("page", currentPage);

        if (yearFilter.value) {
            params.append("year", yearFilter.value);
        }

        if (monthFilter.value) {
            params.append("month", monthFilter.value);
        }

        return `${BASE_API_URL}?${params.toString()}`;
    }

    function loadPage(url) {
        fetch(url)
            .then(res => res.json())
            .then(data => {
                renderTable(data.results);
                updatePagination(data);
            })
            .catch(err => console.error(err));
    }

    function renderTable(rows) {
        tableBody.innerHTML = "";

        rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.province}</td>
                <td>${row.year}</td>
                <td>${row.month}</td>
                <td>${row.events}</td>
                <td>${row.fatalities}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    function updatePagination(data) {
        nextPageUrl = data.next;
        prevPageUrl = data.previous;

        pageInfo.textContent = `Page ${currentPage}`;

        prevBtn.disabled = !prevPageUrl;
        nextBtn.disabled = !nextPageUrl;
    }

    prevBtn.addEventListener("click", () => {
        if (prevPageUrl) {
            currentPage--;
            loadPage(prevPageUrl);
        }
    });

    nextBtn.addEventListener("click", () => {
        if (nextPageUrl) {
            currentPage++;
            loadPage(nextPageUrl);
        }
    });

    applyBtn.addEventListener("click", () => {
        currentPage = 1;
        loadPage(buildUrl());
    });
</script>

</body>
</html>
