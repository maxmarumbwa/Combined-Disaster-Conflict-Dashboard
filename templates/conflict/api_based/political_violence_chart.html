<script>
const apiUrl = "http://localhost:8000/api/table/";

async function fetchAllData(url) {
    let allResults = [];
    while (url) {
        const response = await fetch(url);
        const data = await response.json();
        allResults = allResults.concat(data.results);
        url = data.next; // move to next page
    }
    return allResults;
}

function formatMonthYear(item) {
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return monthNames[item.month - 1] + " " + item.year;
}

async function renderChart() {
    const results = await fetchAllData(apiUrl);

    // Sort by year then month
    results.sort((a, b) => a.year - b.year || a.month - b.month);

    // Get unique month-year labels
    const labelsSet = new Set(results.map(formatMonthYear));
    const labels = Array.from(labelsSet);

    // Group fatalities by province
    const provinces = {};
    results.forEach(item => {
        if (!provinces[item.province]) {
            provinces[item.province] = Array(labels.length).fill(0);
        }
        const index = labels.indexOf(formatMonthYear(item));
        provinces[item.province][index] = item.fatalities;
    });

    // Create dataset for each province
    const datasets = Object.keys(provinces).map((province, i) => {
        const color = `hsl(${(i * 50) % 360}, 70%, 50%)`;
        return {
            label: province,
            data: provinces[province],
            fill: false,
            borderColor: color,
            backgroundColor: color,
            tension: 0.3
        };
    });

    const ctx = document.getElementById('fatalitiesChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Monthly Fatalities by Province'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                },
                legend: {
                    position: 'bottom'
                }
            },
            interaction: {
                mode: 'nearest',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Fatalities'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Month-Year'
                    }
                }
            }
        }
    });
}

renderChart();
</script>
