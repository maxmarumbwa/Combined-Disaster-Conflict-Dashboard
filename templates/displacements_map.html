<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Displacement Events Map</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
    </script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        h2 {
            padding: 10px;
        }

        #map {
            height: 90vh;
            width: 100%;
        }
    </style>
</head>

<body>

<h2>Conflict & Disaster Displacement Events</h2>

<div id="map"></div>

<script>
    // 1️⃣ Create map
    var map = L.map("map").setView([0, 29], 5);

    // 2️⃣ Base map
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // 3️⃣ Fetch GeoJSON from Django
    fetch("{% url 'displacement_geojson' %}")
        .then(response => response.json())
        .then(data => {

            console.log("GeoJSON received:", data); // DEBUG

            if (!data.features || data.features.length === 0) {
                alert("No displacement data found!");
                return;
            }

            // 4️⃣ Add points to map
            var displacementLayer = L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    var color = feature.properties.displacement_type === "Conflict"
                        ? "#d73027"
                        : "#4575b4";

                    return L.circleMarker(latlng, {
                        radius: 6,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        fillOpacity: 0.85
                    });
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(
                        "<strong>" + (feature.properties.displacement_name || "Displacement Event") + "</strong><br>" +
                        "Type: " + feature.properties.displacement_type + "<br>" +
                        "Displaced: " + feature.properties.figure.toLocaleString() + "<br>" +
                        "Date: " + feature.properties.displacement_date
                    );
                }
            }).addTo(map);

            // 5️⃣ Zoom to data
            map.fitBounds(displacementLayer.getBounds());

        })
        .catch(error => {
            console.error("Error loading GeoJSON:", error);
        });
</script>

</body>
</html>
