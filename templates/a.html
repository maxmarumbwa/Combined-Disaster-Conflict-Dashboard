<!DOCTYPE html>
<html>

<head>
    <title>Political Violence Choropleth</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 500px;
        }
    </style>
</head>

<body>

    <h2>Political Violence Choropleth</h2>

    <!-- Controls -->
    <form id="controls">
        <label>Year:</label>
        <select id="year">
            <option value="">-- Select Year --</option>
            {% for y in years %}
            <option value="{{ y }}">{{ y }}</option>
            {% endfor %}
        </select>

        <label>Month:</label>
        <select id="month">
            <option value="">-- Select Month --</option>
            {% for m in months %}
            <option value="{{ m }}">{{ m }}</option>
            {% endfor %}
        </select>

        <label>Indicator:</label>
        <select id="indicator">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
        </select>

        <button type="button" onclick="loadMap()">Load Map</button>
    </form>

    <hr>

    <div id="map"></div>

    <script>
        const map = L.map("map").setView([-3.5, 23.5], 5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "Â© OpenStreetMap"
        }).addTo(map);

        let geoLayer = null;

        function getColor(val) {
            return val > 50 ? "#800026" :
                val > 20 ? "#BD0026" :
                    val > 5 ? "#E31A1C" :
                        "#FFEDA0";
        }

        function loadMap() {
            const year = document.getElementById("year").value;
            const month = document.getElementById("month").value;
            const indicator = document.getElementById("indicator").value;

            if (!year || !month) {
                alert("Please select year and month");
                return;
            }

            const url = `/api/choropleth/?year=${year}&month=${month}&indicator=${indicator}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {

                    if (geoLayer) {
                        map.removeLayer(geoLayer);
                    }

                    geoLayer = L.geoJSON(data, {
                        style: function (feature) {
                            const val = feature.properties.value || 0;
                            return {
                                fillColor: getColor(val),
                                weight: 1,
                                color: "#000",
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function (feature, layer) {
                            layer.bindPopup(
                                `<strong>${feature.properties.name}</strong><br>
                             Value: ${feature.properties.value}`
                            );
                        }
                    }).addTo(map);
                });
        }
    </script>

</body>

</html>