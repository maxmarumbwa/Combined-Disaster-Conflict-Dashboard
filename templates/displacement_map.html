<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GeoJSON Map</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
    </script>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 95vh;
            width: 100%;
        }
    </style>
</head>

<body>

<h3 style="padding:10px">Displacement Events Map</h3>
<div id="map"></div>

<script>
    // 1ï¸âƒ£ Initialize map
    const map = L.map("map").setView([0, 25], 5);

    // 2ï¸âƒ£ Basemap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors"
    }).addTo(map);

    // 3ï¸âƒ£ Fetch your endpoint
    fetch("http://127.0.0.1:8000/geojson/")
        .then(res => res.json())
        .then(data => {

            console.log("RAW DATA:", data);

            // 4ï¸âƒ£ Fix invalid geometry (string â†’ object)
            const fixedGeoJSON = {
                type: "FeatureCollection",
                features: data.features.map(f => ({
                    type: "Feature",
                    geometry: JSON.parse(f.geometry), // ðŸ”¥ FIX
                    properties: f.properties
                }))
            };

            console.log("FIXED GEOJSON:", fixedGeoJSON);

            // 5ï¸âƒ£ Add to map
            const layer = L.geoJSON(fixedGeoJSON, {
                pointToLayer: (feature, latlng) => {
                    const color = feature.properties.type === "Conflict"
                        ? "red"
                        : "blue";

                    return L.circleMarker(latlng, {
                        radius: 7,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        fillOpacity: 0.85
                    });
                },
                onEachFeature: (feature, layer) => {
                    layer.bindPopup(`
                        <strong>${feature.properties.type}</strong><br>
                        Displaced: ${feature.properties.figure}<br>
                        Date: ${feature.properties.date}
                    `);
                }
            }).addTo(map);

            // 6ï¸âƒ£ Zoom to points
            map.fitBounds(layer.getBounds());

        })
        .catch(err => {
            console.error("GeoJSON load error:", err);
        });
</script>

</body>
</html>
