<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence â€“ Province Chart</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        #chartContainer {
            margin-top: 120px;
            padding: 20px;
        }

        canvas {
            width: 60% !important;
            height: 500px !important;
        }
    </style>
</head>

<body>

    <div id="controls">
        <label>Field</label><br>
        <select id="fieldSelect">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
            <option value="fatalities_monthly_mean">Fatalities Monthly Mean</option>
            <option value="events_monthly_mean">Events Monthly Mean</option>
            <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
            <option value="events_anomaly">Events Anomaly</option>
        </select><br><br>

        <label>Year</label><br>
        <select id="yearSelect"></select><br><br>

        <label>Month</label><br>
        <select id="monthSelect">
            <option value="1" selected>January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>

        <!-- Chart type toggle -->
        <div class="chart-toggle">
            <label>Chart Type:</label><br>
            <input type="radio" name="chartType" value="bar" checked> Bar
            <input type="radio" name="chartType" value="line"> Line
            <input type="radio" name="chartType" value="pie"> Pie
        </div>

    </div>

    <div id="chartContainer">
        <canvas id="provinceChart"></canvas>
    </div>

    <script>
        let currentChartType = 'bar'; // default chart type
        let violenceData = {};
        let provinceChart = null;

        /* -------------------- POPULATE YEARS -------------------- */
        function populateYears() {
            const yearSelect = document.getElementById('yearSelect');
            const startYear = 1995;
            const endYear = 2040;
            const defaultYear = 2001;

            for (let y = startYear; y <= endYear; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === defaultYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
        }

        /* -------------------- LOAD API DATA -------------------- */
        async function loadData() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;

            try {
                const res = await fetch(
                    `http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`
                );
                const apiData = await res.json();

                violenceData = {};
                apiData.forEach(item => {
                    violenceData[item.province] = item;
                });

                drawChart();

            } catch (err) {
                console.error('Error loading data', err);
            }
        }

        /* -------------------- DRAW CHART -------------------- */
        function drawChart() {
            const field = document.getElementById('fieldSelect').value;

            const labels = [];
            const values = [];

            Object.keys(violenceData).forEach(province => {
                labels.push(province);
                values.push(violenceData[province][field] ?? 0);
            });

            if (provinceChart) {
                provinceChart.destroy();
            }

            const ctx = document.getElementById('provinceChart').getContext('2d');

            provinceChart = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: field.replaceAll('_', ' ').toUpperCase(),
                        data: values
                    }]
                },
                options: {
                    plugins: {
                        title: {
                            display: true,
                            text: `${field.replaceAll('_', ' ').toUpperCase()} -Number of Political Violence events`,
                        }
                    }
                }
            });
        }

        /* -------------------- EVENTS -------------------- */
        document.getElementById('yearSelect').addEventListener('change', loadData);
        document.getElementById('monthSelect').addEventListener('change', loadData);
        document.getElementById('fieldSelect').addEventListener('change', drawChart);
        document.querySelectorAll('input[name="chartType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentChartType = e.target.value; // update chart type
                drawChart(); // redraw chart
            });
        });



        /* -------------------- INIT -------------------- */
        populateYears();
        loadData();
    </script>

</body>

</html>