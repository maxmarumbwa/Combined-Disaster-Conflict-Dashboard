<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Choropleth Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>#map { height: 100vh; }</style>
</head>

<body>
    <div id="map"></div>

    <script>
        const map = L.map('map').setView([-4.0, 23.6], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let violenceData = {};
        let geoData;

        // Fetch violence data
        fetch('http://localhost:8000/api/political_violence/monthly_anomaly/')
            .then(res => res.json())
            .then(apiData => {
                apiData.forEach(item => {
                    if (!violenceData[item.province]) violenceData[item.province] = {};
                    violenceData[item.province][`${item.year}-${item.month}`] = item;
                });
                console.log('Data loaded for', Object.keys(violenceData).length, 'provinces');
                console.log(violenceData);
            });

        // Load GeoJSON and create choropleth
        fetch("{% static 'data/geojson/geoBoundaries-COD-ADM1.geojson' %}")
            .then(res => res.json())
            .then(data => {
                geoData = data;
                //console.log(geoData);
                createChoropleth(2023, 1, 'events');
            });

        function getColor(value) {
            return value > 150 ? '#800026' :
                   value > 70 ? '#BD0026' :
                   value > 25 ? '#E31A1C' :
                   value > 0  ? '#2afc8c' :
                   value > -25 ? '#FD8D3C' :
                   value > -70 ? '#FEB24C' :
                   value > -150 ? '#FED976' :
                                 '#FFEDA0';
        }

        function createChoropleth(year, month, field) {
            const dateKey = `${year}-${month}`;
            
            if (window.choroplethLayer) {
                map.removeLayer(window.choroplethLayer);
            }

            window.choroplethLayer = L.geoJSON(geoData, {
                style: function(feature) {
                    const province = feature.properties.shapename2;
                    const data = violenceData[province] && violenceData[province][dateKey];
                    const value = data ? data[field] : null;
                    
                    return {
                        fillColor: getColor(value),
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const province = feature.properties.shapename2;
                    console.log('Processing province:', province);
                    const data = violenceData[province] && violenceData[province][dateKey];
                    
                    let popup = `<b>${province}</b>`;
                    if (data) {
                        popup += `<br>${field}: ${data[field].toFixed(1)}`;
                        popup += `<br>Fatalities: ${data.fatalities}`;
                        popup += `<br>Events: ${data.events}`;
                    } else {
                        popup += `<br><i>No data</i>`;
                    }
                    layer.bindPopup(popup);
                }
            }).addTo(map);

            map.fitBounds(window.choroplethLayer.getBounds());
        }

        // Simple controls
        L.control.layers({}, {
            'Fatalities Anomaly 1997-01': window.choroplethLayer
        }).addTo(map);
    </script>
</body>
</html>