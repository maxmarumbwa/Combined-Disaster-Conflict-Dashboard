<!DOCTYPE html>
<html>
{% load static %}
<head>
    <title>Political Violence Choropleth</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map { height: 100vh; }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: Arial;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 6px;
            z-index: 2000;
        }
    </style>
</head>

<body>

<div id="controls">
    <label>Field</label><br>
    <select id="fieldSelect">
        <option value="fatalities">Fatalities</option>
        <option value="events">Events</option>
        <option value="fatalities_monthly_mean">Fatalities Monthly Mean</option>
        <option value="events_monthly_mean">Events Monthly Mean</option>
        <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
        <option value="events_anomaly">Events Anomaly</option>
    </select><br><br>

    <label>Year</label><br>
    <select id="yearSelect">
        <option value="2001" selected>2001</option>
        <option value="2000">2000</option>
        <option value="1999">1999</option>
    </select><br><br>

    <label>Month</label><br>
    <select id="monthSelect">
        <option value="1" selected>January</option>
        <option value="2">February</option>
        <option value="3">March</option>
    </select>
</div>

<div id="loading">Loading data...</div>
<div id="map"></div>

<script>
/* -------------------- MAP SETUP -------------------- */
const map = L.map('map').setView([-4.0, 23.6], 5);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
    .addTo(map);

let violenceData = {};
let geoData;
let layer;

/* -------------------- LOAD GEOJSON -------------------- */
async function loadGeoJSON() {
    const res = await fetch("{% static 'data/geojson/a.geojson' %}");
    geoData = await res.json();
}

/* -------------------- LOAD API DATA -------------------- */
async function loadData() {
    const year = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    const field = document.getElementById('fieldSelect').value;

    document.getElementById('loading').style.display = 'block';

    try {
        const res = await fetch(
            `http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`
        );
        const apiData = await res.json();

        violenceData = {};
        apiData.forEach(item => {
            violenceData[item.province] = item;
        });

        document.getElementById('loading').style.display = 'none';
        drawMap(field);

    } catch (err) {
        document.getElementById('loading').innerHTML = 'Error loading data';
    }
}

/* -------------------- DRAW CHOROPLETH -------------------- */
function drawMap(field) {

    if (layer) map.removeLayer(layer);

    const getColor = v =>
        v == null ? '#ccc' :
        v > 50 ? '#800026' :
        v > 20 ? '#BD0026' :
        v > 10 ? '#E31A1C' :
        v > 0  ? '#FC4E2A' :
        v > -10 ? '#FD8D3C' :
        v > -20 ? '#FEB24C' :
        '#FFEDA0';

    layer = L.geoJSON(geoData, {
        style: f => {
            const province = f.properties.shapeName;
            const d = violenceData[province];

            return {
                fillColor: getColor(d?.[field]),
                weight: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        },
        onEachFeature: (f, l) => {
            const province = f.properties.shapeName;
            const d = violenceData[province];

            l.bindPopup(d
                ? `<b>${province}</b><br>
                   ${field}: ${d[field]}<br>
                   Fatalities: ${d.fatalities}<br>
                   Events: ${d.events}`
                : `<b>${province}</b><br>No data`);
        }
    }).addTo(map);

    map.fitBounds(layer.getBounds());
}

/* -------------------- EVENTS -------------------- */
document.getElementById('fieldSelect').addEventListener('change', loadData);
document.getElementById('yearSelect').addEventListener('change', loadData);
document.getElementById('monthSelect').addEventListener('change', loadData);

/* -------------------- INIT -------------------- */
(async function init() {
    await loadGeoJSON();
    loadData();
})();
</script>

</body>
</html>
