<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Choropleth Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }
    </style>
</head>

<body>
    <div id="loading">Loading map data...</div>
    <div id="map"></div>

<script>
/* 1. Create the map */
const map = L.map('map').setView([-4.0, 23.6], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let violenceData = {};
let geoData;

/* 2. Load all data using async/await */
async function loadData() {
    try {
        const apiRes = await fetch('http://localhost:8000/api/political_violence/monthly_anomaly/');
        const apiData = await apiRes.json();

        const geoRes = await fetch("{% static 'data/geojson/a.geojson' %}");
        geoData = await geoRes.json();

        apiData.forEach(item => {
            if (!violenceData[item.province]) violenceData[item.province] = {};
            violenceData[item.province][`${item.year}-${item.month}`] = item;
        });

        document.getElementById('loading').style.display = 'none';
        createChoropleth(1997, 1, 'fatalities_anomaly');

    } catch (error) {
        document.getElementById('loading').innerHTML = 'Error loading data';
    }
}

/* 3. Draw choropleth */
function createChoropleth(year, month, field) {
    const dateKey = `${year}-${month}`;

    if (window.layer) map.removeLayer(window.layer);

    const getColor = v =>
        v == null ? '#ccc' :
        v > 50 ? '#800026' :
        v > 20 ? '#BD0026' :
        v > 10 ? '#E31A1C' :
        v > 0  ? '#FC4E2A' :
        v > -10 ? '#FD8D3C' :
        v > -20 ? '#FEB24C' :
        '#FFEDA0';

    window.layer = L.geoJSON(geoData, {
        style: f => {
            const p = f.properties.shapeName;
            const d = violenceData[p]?.[dateKey];
            return {
                fillColor: getColor(d?.[field]),
                color: 'white',
                weight: 1,
                fillOpacity: 0.7
            };
        },
        onEachFeature: (f, l) => {
            const p = f.properties.shapeName;
            const d = violenceData[p]?.[dateKey];
            l.bindPopup(d
                ? `<b>${p}</b><br>Fatalities: ${d.fatalities}<br>Events: ${d.events}`
                : `<b>${p}</b><br>No data`);
        }
    }).addTo(map);

    map.fitBounds(window.layer.getBounds());
}

/* 4. Start everything */
loadData();
</script>

</body>
</html>