<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence Period Comparison</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 3000;
            background: white;
            padding: 12px;
            border-radius: 6px;
            width: 260px;
            font-size: 13px;
        }

        #container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            height: 100vh;
        }

        .map {
            position: relative;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 8px;
            font-size: 12px;
            border-radius: 6px;
            line-height: 16px;
        }

        .legend i {
            width: 14px;
            height: 14px;
            float: left;
            margin-right: 6px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <div id="controls">
        <strong>Field</strong><br>
        <select id="fieldSelect">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
            <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
            <option value="events_anomaly">Events Anomaly</option>
        </select>

        <hr>

        <strong>START PERIOD</strong><br>
        Year:
        <select id="yearStart">
            <option value="2001">2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
        </select>
        Month:
        <select id="monthStart">
            <option value="1">Jan</option>
            <option value="2">Feb</option>
            <option value="3">Mar</option>
        </select>

        <hr>

        <strong>END PERIOD</strong><br>
        Year:
        <select id="yearEnd">
            <option value="2001">2001</option>
            <option value="2002" selected>2002</option>
            <option value="2003">2003</option>
        </select>
        Month:
        <select id="monthEnd">
            <option value="1">Jan</option>
            <option value="2" selected>Feb</option>
            <option value="3">Mar</option>
        </select>

        <hr>

        <strong>DIFFERENCE MAPS</strong><br>
        <em>Absolute Difference:</em><br>
        <code>End − Start</code><br><br>

        <em>Percentage Difference:</em><br>
        <code>((End − Start) / |Start|) × 100</code>
    </div>

    <div id="container">
        <div id="mapStart" class="map"></div>
        <div id="mapEnd" class="map"></div>
        <div id="mapDiff" class="map"></div>
        <div id="mapPct" class="map"></div>
    </div>

    <script>
        /* ================= MAP SETUP ================= */

        const maps = {
            start: L.map('mapStart').setView([-4, 23.6], 5),
            end: L.map('mapEnd').setView([-4, 23.6], 5),
            diff: L.map('mapDiff').setView([-4, 23.6], 5),
            pct: L.map('mapPct').setView([-4, 23.6], 5)
        };

        for (const k in maps) {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(maps[k]);
        }

        /* ================= SYNC ZOOM ================= */

        let syncing = false;

        function syncMaps(source) {
            if (syncing) return;
            syncing = true;

            for (const k in maps) {
                if (maps[k] !== source) {
                    maps[k].setView(source.getCenter(), source.getZoom(), { animate: false });
                }
            }

            syncing = false;
        }

        for (const k in maps) {
            maps[k].on('moveend', (e) => syncMaps(e.target));
        }

        /* ================= LEGEND CONTROLS ================= */

        let legendStart, legendEnd, legendDiff, legendPct;

        function getNormalLegendHTML(field) {
            let title = "Magnitude (Absolute Value)";
            if (field === "fatalities") title = "Fatalities (Absolute)";
            if (field === "events") title = "Events (Absolute)";
            if (field.includes("anomaly")) title = "Anomaly Magnitude (|value|)";

            return `
    <strong>${title}</strong><br>
    <i style="background:#800026"></i> > 50<br>
    <i style="background:#BD0026"></i> 20 – 50<br>
    <i style="background:#E31A1C"></i> 10 – 20<br>
    <i style="background:#FC4E2A"></i> 5 – 10<br>
    <i style="background:#FD8D3C"></i> 1 – 5<br>
    <i style="background:#FFEDA0"></i> 0 – 1
    `;
        }

        // Classified difference legend (qualitative)
        function getDifferenceLegendHTML(title) {
            return `
    <strong>${title}</strong><br>
    <i style="background:#08306b"></i> Large Increase<br>
    <i style="background:#6baed6"></i> Small Increase<br>
    <i style="background:#ffffff"></i> No Change<br>
    <i style="background:#fb6a4a"></i> Small Decrease<br>
    <i style="background:#a50f15"></i> Large Decrease
    `;
        }

        function setLegend(map, legendVar, html) {
            if (legendVar) map.removeControl(legendVar);

            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = () => {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = html;
                return div;
            };
            legend.addTo(map);
            return legend;
        }

        /* ================= COLORS ================= */

        function normalColor(value) {
            if (value == null) return '#ccc';
            const v = Math.abs(value);
            if (v > 50) return '#800026';
            if (v > 20) return '#BD0026';
            if (v > 10) return '#E31A1C';
            if (v > 5) return '#FC4E2A';
            if (v > 1) return '#FD8D3C';
            return '#FFEDA0';
        }

        // Difference coloring: classified ranges
        function diffColor(v) {
            if (v == null) return '#ccc';
            if (v > 50) return '#08306b';   // Large Increase
            if (v > 0) return '#6baed6';    // Small Increase
            if (v === 0) return '#ffffff';  // No Change
            if (v > -20) return '#fb6a4a';  // Small Decrease
            return '#a50f15';               // Large Decrease
        }

        /* ================= DATA ================= */

        let geoData;
        let layers = {};

        async function fetchData(year, month) {
            const response = await fetch(
                `http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`
            );
            const data = await response.json();
            const out = {};
            data.forEach(row => out[row.province] = row);
            return out;
        }

        function drawLayer(map, oldLayer, data, field, colorFn) {
            if (oldLayer) map.removeLayer(oldLayer);

            return L.geoJSON(geoData, {
                style: feature => {
                    const rec = data[feature.properties.shapename2];
                    const value = rec ? rec[field] : null;
                    return {
                        fillColor: colorFn(value),
                        weight: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                }
            }).addTo(map);
        }

        /* ================= UPDATE ALL ================= */

        async function updateAll() {
            const field = fieldSelect.value;

            // Fetch data
            const startData = await fetchData(yearStart.value, monthStart.value);
            const endData = await fetchData(yearEnd.value, monthEnd.value);

            const diffData = {};
            const pctData = {};

            for (const p in startData) {
                if (endData[p]) {
                    const s = startData[p][field];
                    const e = endData[p][field];

                    diffData[p] = { [field]: e - s }; // raw difference
                    pctData[p] = { [field]: s !== 0 ? ((e - s) / Math.abs(s)) * 100 : null };
                }
            }

            // Update legends (classified)
            legendStart = setLegend(maps.start, legendStart, getNormalLegendHTML(field));
            legendEnd = setLegend(maps.end, legendEnd, getNormalLegendHTML(field));
            legendDiff = setLegend(maps.diff, legendDiff, getDifferenceLegendHTML("Absolute Difference"));
            legendPct = setLegend(maps.pct, legendPct, getDifferenceLegendHTML("Percentage Difference"));

            // Draw layers
            layers.start = drawLayer(maps.start, layers.start, startData, field, normalColor);
            layers.end = drawLayer(maps.end, layers.end, endData, field, normalColor);
            layers.diff = drawLayer(maps.diff, layers.diff, diffData, field, diffColor);
            layers.pct = drawLayer(maps.pct, layers.pct, pctData, field, diffColor);
        }

        /* ================= INIT ================= */

        (async function init() {
            const res = await fetch("{% static 'data/geojson/geoBoundaries-COD-ADM1_new.geojson' %}");
            geoData = await res.json();
            updateAll();
        })();

        document.querySelectorAll("select").forEach(el => el.addEventListener("change", updateAll));
    </script>




</body>

</html>