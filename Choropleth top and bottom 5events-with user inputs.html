<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence Choropleth</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map {
            height: 100vh;
        }

        /* TOP RIGHT CONTROLS */
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: Arial;
            width: 220px;
        }

        /* LEFT RANKING PANEL */
        #rankingPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: Arial;
            width: 250px;
            max-height: 90vh;
            overflow-y: auto;
        }

        #rankingPanel h3 {
            margin: 5px 0;
            font-size: 14px;
        }

        #rankingPanel ul {
            padding-left: 18px;
            margin-top: 5px;
        }

        #rankingPanel li {
            font-size: 12px;
            margin-bottom: 4px;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 15px;
            border-radius: 6px;
            z-index: 2000;
        }

        /* LEGEND */
        .legend {
            background: white;
            padding: 6px 8px;
            font-size: 12px;
            line-height: 18px;
            color: #555;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border-radius: 6px;
            z-index: 1000;
        }

        .legend i {
            width: 14px;
            height: 14px;
            float: left;
            margin-right: 6px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <!-- LEFT PANEL -->
    <div id="rankingPanel">
        <h3>Top 5 Provinces</h3>
        <ul id="topList"></ul>

        <h3>Bottom 5 Provinces</h3>
        <ul id="bottomList"></ul>

        <label>Top N Provinces</label><br>
        <input type="number" id="topN" value="5" min="1" style="width:50px;"><br><br>

        <label>Bottom N Provinces</label><br>
        <input type="number" id="bottomN" value="5" min="1" style="width:50px;"><br><br>

    </div>

    <!-- RIGHT CONTROLS -->
    <div id="controls">
        <label>Field</label><br>
        <select id="fieldSelect">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
            <option value="fatalities_monthly_mean">Fatalities Monthly Mean</option>
            <option value="events_monthly_mean">Events Monthly Mean</option>
            <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
            <option value="events_anomaly">Events Anomaly</option>
        </select><br><br>

        <label>Year</label><br>
        <select id="yearSelect">
            <option value="2001" selected>2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
            <option value="2005">2005</option>
            <option value="2006">2006</option>
            <option value="2007">2007</option>
            <option value="2008">2008</option>
            <option value="2009">2009</option>
            <option value="2010">2010</option>
            <option value="2011">2011</option>
            <option value="2012">2012</option>
        </select><br><br>

        <label>Month</label><br>
        <select id="monthSelect">
            <option value="1" selected>January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
    </div>

    <div id="loading">Loading data...</div>
    <div id="map"></div>

    <script>
        /* ---------------- MAP SETUP ---------------- */
        var map = L.map('map').setView([-4.0, 23.6], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        var geoData = null;
        var violenceData = {};
        var layer = null;

        /* ---------------- LOAD GEOJSON ---------------- */
        function loadGeoJSON() {
            return fetch("{% static 'data/geojson/geoBoundaries-COD-ADM1_new.geojson' %}")
                .then(function (response) { return response.json(); })
                .then(function (data) { geoData = data; });
        }

        /* ---------------- LOAD API DATA ---------------- */
        function loadData() {
            var year = document.getElementById('yearSelect').value;
            var month = document.getElementById('monthSelect').value;
            var field = document.getElementById('fieldSelect').value;

            document.getElementById('loading').style.display = 'block';

            fetch("http://localhost:8000/api/political_violence/monthly_anomaly/?year=" + year + "&month=" + month)
                .then(function (response) { return response.json(); })
                .then(function (apiData) {
                    violenceData = {};
                    for (var i = 0; i < apiData.length; i++) {
                        violenceData[apiData[i].province] = apiData[i];
                    }
                    document.getElementById('loading').style.display = 'none';

                    drawMap(field);
                    updateRankingPanel(field);
                    updateLegend(field);
                });
        }

        /* ---------------- DRAW MAP ---------------- */
        function drawMap(field) {
            if (layer) { map.removeLayer(layer); }

            function getColor(value) {
                if (value == null) return '#ccc';
                if (value > 50) return '#800026';
                if (value > 20) return '#BD0026';
                if (value > 10) return '#E31A1C';
                if (value > 0) return '#FC4E2A';
                if (value > -10) return '#FD8D3C';
                if (value > -20) return '#FEB24C';
                return '#FFEDA0';
            }

            layer = L.geoJSON(geoData, {
                style: function (feature) {
                    var province = feature.properties.shapename2;
                    var record = violenceData[province];
                    return {
                        fillColor: record ? getColor(record[field]) : '#ccc',
                        weight: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    var province = feature.properties.shapename2;
                    var record = violenceData[province];
                    var popupContent = "<b>" + province + "</b><br>";
                    if (record) {
                        popupContent += field + ": " + record[field] + "<br>" +
                            "Fatalities: " + record.fatalities + "<br>" +
                            "Events: " + record.events;
                    } else {
                        popupContent += "No data";
                    }
                    layer.bindPopup(popupContent);
                }
            }).addTo(map);

            map.fitBounds(layer.getBounds());
        }

        /* ---------------- RANKING PANEL ---------------- */
        function updateRankingPanel(field) {
            var topN = parseInt(document.getElementById('topN').value) || 5;
            var bottomN = parseInt(document.getElementById('bottomN').value) || 5;

            var records = [];
            for (var province in violenceData) {
                var value = violenceData[province][field];
                if (value !== null && value !== undefined) {
                    records.push({ province: province, value: value });
                }
            }

            records.sort(function (a, b) { return b.value - a.value; });

            var topList = document.getElementById('topList');
            var bottomList = document.getElementById('bottomList');

            topList.innerHTML = '';
            bottomList.innerHTML = '';

            for (var i = 0; i < topN && i < records.length; i++) {
                var li = document.createElement('li');
                li.textContent = records[i].province + ': ' + records[i].value;
                topList.appendChild(li);
            }

            for (var j = records.length - 1; j >= records.length - bottomN && j >= 0; j--) {
                var li2 = document.createElement('li');
                li2.textContent = records[j].province + ': ' + records[j].value;
                bottomList.appendChild(li2);
            }
        }

        /* ---------------- LEGEND ---------------- */
        var legend = L.control({ position: 'bottomright' });

        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'legend');
            return div;
        };

        legend.addTo(map);

        function updateLegend(field) {
            var div = document.querySelector(".legend");
            if (!div) return;

            var bins = [
                { color: '#800026', label: '> 50' },
                { color: '#BD0026', label: '20 – 50' },
                { color: '#E31A1C', label: '10 – 20' },
                { color: '#FC4E2A', label: '0 – 10' },
                { color: '#FD8D3C', label: '-10 – 0' },
                { color: '#FEB24C', label: '-20 – -10' },
                { color: '#FFEDA0', label: '≤ -20' }
            ];

            div.innerHTML = "<strong>" + field.replace(/_/g, ' ').toUpperCase() + "</strong><br>" +
                bins.map(function (b) {
                    return "<i style='background:" + b.color + "'></i> " + b.label + "<br>";
                }).join('');
        }

        /* ---------------- EVENTS ---------------- */
        document.getElementById('fieldSelect').addEventListener('change', loadData);
        document.getElementById('yearSelect').addEventListener('change', loadData);
        document.getElementById('monthSelect').addEventListener('change', loadData);

        document.getElementById('topN').addEventListener('change', function () {
            var field = document.getElementById('fieldSelect').value;
            updateRankingPanel(field);
        });

        document.getElementById('bottomN').addEventListener('change', function () {
            var field = document.getElementById('fieldSelect').value;
            updateRankingPanel(field);
        });

        /* ---------------- INIT ---------------- */
        loadGeoJSON().then(function () {
            loadData();
        });
    </script>

</body>

</html>