<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence Choropleth</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FileSaver.js for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        #map {
            height: 100vh;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            font-family: Arial;
        }

        #aggStats {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            width: 450px;
        }

        canvas {
            width: 100% !important;
            height: 300px !important;
        }
    </style>
</head>

<body>

    <div id="controls">
        <label>Field</label><br>
        <select id="fieldSelect">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
            <option value="fatalities_monthly_mean">Fatalities Monthly Mean</option>
            <option value="events_monthly_mean">Events Monthly Mean</option>
            <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
            <option value="events_anomaly">Events Anomaly</option>
        </select><br><br>

        <label>Year</label><br>
        <select id="yearSelect">
            <option value="2001" selected>2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
            <option value="2005">2005</option>
            <option value="2006">2006</option>
            <option value="2007">2007</option>
            <option value="2008">2008</option>
            <option value="2009">2009</option>
            <option value="2010">2010</option>
            <option value="2011">2011</option>
            <option value="2012">2012</option>
        </select><br><br>

        <label>Month</label><br>
        <select id="monthSelect">
            <option value="1" selected>January</option>
            <option value="2">February</option>
            <option value="3">March</option>
            <option value="4">April</option>
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
    </div>

    <div id="aggStats">
        <canvas id="provinceChart"></canvas>
    </div>

    <div id="map"></div>

    <script>
        /* -------------------- MAP SETUP -------------------- */
        const map = L.map('map').setView([-4.0, 23.6], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let geoData;
        let violenceData = {};
        let layer;
        let provinceChart = null;

        /* -------------------- LOAD GEOJSON -------------------- */
        async function loadGeoJSON() {
            const res = await fetch("{% static 'data/geojson/geoBoundaries-COD-ADM1_new.geojson' %}");
            geoData = await res.json();
        }

        /* -------------------- LOAD API DATA -------------------- */
        async function loadData() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;

            try {
                const res = await fetch(
                    `http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`
                );
                const apiData = await res.json();

                violenceData = {};
                apiData.forEach(item => {
                    violenceData[item.province] = item;
                });

                drawMap();
                drawChart();

            } catch (err) {
                console.error('Error loading data', err);
            }
        }

        /* -------------------- DRAW MAP (UNCHANGED) -------------------- */
        function drawMap() {
            if (layer) map.removeLayer(layer);

            layer = L.geoJSON(geoData, {
                style: f => ({
                    fillColor: 'grey',
                    weight: 1,
                    color: 'black',
                    fillOpacity: 0.2
                }),
                onEachFeature: (f, l) => {
                    const province = f.properties.shapename2;
                    const d = violenceData[province];

                    if (d) {
                        let popupContent = `<b>${province}</b><br>`;
                        for (const key in d) {
                            popupContent += `${key}: ${d[key]}<br>`;
                        }
                        l.bindPopup(popupContent);
                    } else {
                        l.bindPopup(`<b>${province}</b><br>No data`);
                    }
                }
            }).addTo(map);

            map.fitBounds(layer.getBounds());
        }

        /* -------------------- DRAW CHART -------------------- */
        function drawChart() {
            const field = document.getElementById('fieldSelect').value;

            const labels = [];
            const values = [];

            Object.keys(violenceData).forEach(province => {
                labels.push(province);
                values.push(violenceData[province][field] ?? 0);
            });

            if (provinceChart) {
                provinceChart.destroy();
            }

            const ctx = document.getElementById('provinceChart').getContext('2d');

            provinceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: field.replaceAll('_', ' ').toUpperCase(),
                        data: values
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        /* -------------------- EVENTS -------------------- */
        document.getElementById('yearSelect').addEventListener('change', loadData);
        document.getElementById('monthSelect').addEventListener('change', loadData);
        document.getElementById('fieldSelect').addEventListener('change', () => {
            drawMap();
            drawChart();
        });

        /* -------------------- INIT -------------------- */
        (async function init() {
            await loadGeoJSON();
            loadData();
        })();
    </script>

</body>

</html>