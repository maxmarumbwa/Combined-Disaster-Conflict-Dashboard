<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence Comparison</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        .map {
            flex: 1;
            position: relative;
        }

        /* CONTROLS */
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
        }

        /* LEGEND */
        .legend {
            background: white;
            padding: 6px 8px;
            font-size: 12px;
            line-height: 18px;
            color: #555;
            position: absolute;
            bottom: 10px;
            right: 10px;
            border-radius: 6px;
            z-index: 1000;
        }

        .legend i {
            width: 14px;
            height: 14px;
            float: left;
            margin-right: 6px;
            opacity: 0.9;
        }
    </style>
</head>

<body>

    <div id="controls">
        <label>Field:</label>
        <select id="fieldSelect">
            <option value="fatalities">Fatalities</option>
            <option value="events">Events</option>
            <option value="fatalities_monthly_mean">Fatalities Monthly Mean</option>
            <option value="events_monthly_mean">Events Monthly Mean</option>
            <option value="fatalities_anomaly" selected>Fatalities Anomaly</option>
            <option value="events_anomaly">Events Anomaly</option>
        </select><br><br>

        <label>Left Map - Year:</label>
        <select id="yearLeft">
            <option value="2001" selected>2001</option>
            <option value="2002">2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
        </select><br>
        <label>Month:</label>
        <select id="monthLeft">
            <option value="1" selected>Jan</option>
            <option value="2">Feb</option>
            <option value="3">Mar</option>
            <option value="4">Apr</option>
        </select><br><br>

        <label>Right Map - Year:</label>
        <select id="yearRight">
            <option value="2001">2001</option>
            <option value="2002" selected>2002</option>
            <option value="2003">2003</option>
            <option value="2004">2004</option>
        </select><br>
        <label>Month:</label>
        <select id="monthRight">
            <option value="1">Jan</option>
            <option value="2" selected>Feb</option>
            <option value="3">Mar</option>
            <option value="4">Apr</option>
        </select>
    </div>

    <div id="container">
        <div id="mapLeft" class="map"></div>
        <div id="mapRight" class="map"></div>
    </div>

    <script>
        var geoData = null;

        // Create two maps
        var mapLeft = L.map('mapLeft').setView([-4.0, 23.6], 5);
        var mapRight = L.map('mapRight').setView([-4.0, 23.6], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapLeft);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapRight);

        var layerLeft = null;
        var layerRight = null;

        // Legend for both maps
        var legendLeft = L.control({ position: 'bottomright' });
        var legendRight = L.control({ position: 'bottomright' });

        legendLeft.onAdd = function () {
            var div = L.DomUtil.create('div', 'legend');
            return div;
        };
        legendRight.onAdd = function () {
            var div = L.DomUtil.create('div', 'legend');
            return div;
        };

        legendLeft.addTo(mapLeft);
        legendRight.addTo(mapRight);

        // Load GeoJSON
        fetch("{% static 'data/geojson/geoBoundaries-COD-ADM1_new.geojson' %}")
            .then(res => res.json())
            .then(data => { geoData = data; drawAllMaps(); });

        function getColor(value) {
            if (value == null) return '#ccc';
            if (value > 50) return '#800026';
            if (value > 20) return '#BD0026';
            if (value > 10) return '#E31A1C';
            if (value > 0) return '#FC4E2A';
            if (value > -10) return '#FD8D3C';
            if (value > -20) return '#FEB24C';
            return '#FFEDA0';
        }

        function fetchData(year, month) {
            return fetch(`http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`)
                .then(res => res.json())
                .then(data => {
                    var dict = {};
                    data.forEach(d => { dict[d.province] = d; });
                    return dict;
                });
        }

        function drawMap(map, layerVar, data, field) {
            if (layerVar) map.removeLayer(layerVar);
            layerVar = L.geoJSON(geoData, {
                style: function (feature) {
                    var record = data[feature.properties.shapename2];
                    return {
                        fillColor: record ? getColor(record[field]) : '#ccc',
                        weight: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function (feature, layer) {
                    var record = data[feature.properties.shapename2];
                    var popup = "<b>" + feature.properties.shapename2 + "</b><br>";
                    if (record) popup += field + ": " + record[field] + "<br>Fatalities: " + record.fatalities + "<br>Events: " + record.events;
                    else popup += "No data";
                    layer.bindPopup(popup);
                }
            }).addTo(map);
            map.fitBounds(layerVar.getBounds());
            return layerVar;
        }

        function updateLegend(divClass, field) {
            var div = document.querySelector(divClass);
            var bins = [
                { color: '#800026', label: '> 50' },
                { color: '#BD0026', label: '20 – 50' },
                { color: '#E31A1C', label: '10 – 20' },
                { color: '#FC4E2A', label: '0 – 10' },
                { color: '#FD8D3C', label: '-10 – 0' },
                { color: '#FEB24C', label: '-20 – -10' },
                { color: '#FFEDA0', label: '≤ -20' }
            ];
            div.innerHTML = "<strong>" + field.replace(/_/g, ' ').toUpperCase() + "</strong><br>" +
                bins.map(b => `<i style='background:${b.color}'></i> ${b.label}<br>`).join('');
        }

        function drawAllMaps() {
            var field = document.getElementById('fieldSelect').value;
            var yearL = document.getElementById('yearLeft').value;
            var monthL = document.getElementById('monthLeft').value;
            var yearR = document.getElementById('yearRight').value;
            var monthR = document.getElementById('monthRight').value;

            Promise.all([fetchData(yearL, monthL), fetchData(yearR, monthR)]).then(results => {
                layerLeft = drawMap(mapLeft, layerLeft, results[0], field);
                layerRight = drawMap(mapRight, layerRight, results[1], field);
                updateLegend("#mapLeft .legend", field);
                updateLegend("#mapRight .legend", field);
            });
        }

        // Event listeners
        ["fieldSelect", "yearLeft", "monthLeft", "yearRight", "monthRight"].forEach(id => {
            document.getElementById(id).addEventListener("change", drawAllMaps);
        });

    </script>

</body>

</html>