<!DOCTYPE html>
<html>
{% load static %}

<head>
    <title>Political Violence â€“ Province Chart</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 250px;
        }

        #chartContainer {
            margin-left: 290px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        canvas {
            width: 100% !important;
            height: 600px !important;
        }

        .dataset-option {
            margin: 5px 0;
            padding: 3px 0;
        }

        .dataset-option label {
            margin-left: 5px;
            font-size: 14px;
        }

        .control-group {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .control-group:last-child {
            border-bottom: none;
        }

        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .chart-toggle {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div id="controls">
        <div class="control-group">
            <label>Year</label>
            <select id="yearSelect"></select>
        </div>

        <div class="control-group">
            <label>Month</label>
            <select id="monthSelect">
                <option value="1" selected>January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>

        <div class="control-group">
            <label>Chart Type</label>
            <div class="chart-toggle">
                <div>
                    <input type="radio" name="chartType" value="bar" id="barChart" checked>
                    <label for="barChart">Bar</label>
                </div>
                <div>
                    <input type="radio" name="chartType" value="line" id="lineChart">
                    <label for="lineChart">Line</label>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label>Datasets to Display</label>
            <div>
                <!-- Actual Values -->
                <div class="dataset-option">
                    <input type="checkbox" id="showFatalities" checked>
                    <label for="showFatalities">Fatalities</label>
                </div>
                <div class="dataset-option">
                    <input type="checkbox" id="showEvents" checked>
                    <label for="showEvents">Events</label>
                </div>

                <!-- Monthly Means -->
                <div class="dataset-option">
                    <input type="checkbox" id="showFatalitiesMean">
                    <label for="showFatalitiesMean">Fatalities Monthly Mean</label>
                </div>
                <div class="dataset-option">
                    <input type="checkbox" id="showEventsMean">
                    <label for="showEventsMean">Events Monthly Mean</label>
                </div>
            </div>
        </div>
    </div>

    <div id="chartContainer">
        <canvas id="provinceChart"></canvas>
    </div>

    <script>
        let currentChartType = 'bar';
        let violenceData = {};
        let provinceChart = null;

        /* -------------------- POPULATE YEARS -------------------- */
        function populateYears() {
            const yearSelect = document.getElementById('yearSelect');
            const startYear = 1995;
            const endYear = 2040;
            const defaultYear = 2001;

            for (let y = startYear; y <= endYear; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === defaultYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
        }

        /* -------------------- LOAD API DATA -------------------- */
        async function loadData() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;

            try {
                const res = await fetch(
                    `http://localhost:8000/api/political_violence/monthly_anomaly/?year=${year}&month=${month}`
                );
                const apiData = await res.json();

                violenceData = {};
                apiData.forEach(item => {
                    violenceData[item.province] = item;
                });

                drawChart();

            } catch (err) {
                console.error('Error loading data', err);
            }
        }

        /* -------------------- DRAW CHART -------------------- */
        function drawChart() {
            const datasets = [];
            const labels = Object.keys(violenceData);

            // Check which datasets to show
            const showFatalities = document.getElementById('showFatalities').checked;
            const showEvents = document.getElementById('showEvents').checked;
            const showFatalitiesMean = document.getElementById('showFatalitiesMean').checked;
            const showEventsMean = document.getElementById('showEventsMean').checked;

            // Prepare datasets based on selections
            if (showFatalities && violenceData) {
                datasets.push({
                    label: 'Fatalities',
                    data: labels.map(province => violenceData[province]?.fatalities ?? 0),
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                });
            }

            if (showEvents && violenceData) {
                datasets.push({
                    label: 'Events',
                    data: labels.map(province => violenceData[province]?.events ?? 0),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                });
            }

            if (showFatalitiesMean && violenceData) {
                datasets.push({
                    label: 'Fatalities Monthly Mean',
                    data: labels.map(province => violenceData[province]?.fatalities_monthly_mean ?? 0),
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2
                });
            }

            if (showEventsMean && violenceData) {
                datasets.push({
                    label: 'Events Monthly Mean',
                    data: labels.map(province => violenceData[province]?.events_monthly_mean ?? 0),
                    backgroundColor: 'rgba(75, 192, 192, 0.7)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 2
                });
            }

            // Destroy existing chart
            if (provinceChart) {
                provinceChart.destroy();
            }

            const ctx = document.getElementById('provinceChart').getContext('2d');

            // Create chart
            if (datasets.length > 0) {
                provinceChart = new Chart(ctx, {
                    type: currentChartType,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Political Violence Data'
                            },
                            legend: {
                                position: 'top',
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        }

        /* -------------------- EVENTS -------------------- */
        document.getElementById('yearSelect').addEventListener('change', loadData);
        document.getElementById('monthSelect').addEventListener('change', loadData);

        // Chart type toggle
        document.querySelectorAll('input[name="chartType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentChartType = e.target.value;
                drawChart();
            });
        });

        // Dataset visibility toggles
        document.getElementById('showFatalities').addEventListener('change', drawChart);
        document.getElementById('showEvents').addEventListener('change', drawChart);
        document.getElementById('showFatalitiesMean').addEventListener('change', drawChart);
        document.getElementById('showEventsMean').addEventListener('change', drawChart);

        /* -------------------- INIT -------------------- */
        populateYears();
        loadData();
    </script>

</body>

</html>